import{EacReadTheFeed,setGridItemsGlobalLink}from"../modules/eac-modules.js";class widgetRssReader extends elementorModules.frontend.handlers.Base{getDefaultSettings(){return{selectors:{targetInstance:".eac-rss-galerie",targetSelect:".select__options-items",targetButton:"#rss__read-button",targetHeader:".rss-item__header",targetLoader:"#rss__loader-wheel",targetNonce:"#rss_nonce",target:".rss-galerie"}}}getDefaultElements(){const e=this.getSettings("selectors");return{$targetInstance:this.$element.find(e.targetInstance),$targetSelect:this.$element.find(e.targetSelect),$targetButton:this.$element.find(e.targetButton),$targetHeader:this.$element.find(e.targetHeader),$targetLoader:this.$element.find(e.targetLoader),targetNonce:this.$element.find(e.targetNonce).val(),$target:this.$element.find(e.target),settings:this.$element.find(e.target).data("settings")||{},instanceAjax:null,is_ios:/(Macintosh|iPhone|iPod|iPad).*AppleWebKit.*Safari/i.test(navigator.userAgent),widgetId:this.$element.data("id")}}onInit(){super.onInit(),this.elements.$targetSelect.find("option:first").attr("selected","selected")}bindEvents(){Object.keys(this.elements.settings).length>0&&!elementorFrontend.isEditMode()&&(this.elements.$targetSelect.on("change",this.onSelectChange.bind(this)),this.elements.$targetButton.on("click touch",this.onTriggerButton.bind(this)),this.elements.$targetInstance.on("keydown",this.onTriggerKeyboard.bind(this)),jQuery(document).on("ajaxComplete",this.ajaxQueryComplete.bind(this)))}removeEmojis(e){return e?e.replace(/([#0-9]\u20E3)|[\xA9\xAE\u203C\u2047-\u2049\u2122\u2139\u3030\u303D\u3297\u3299][\uFE00-\uFEFF]?|[\u2190-\u21FF][\uFE00-\uFEFF]?|[\u2300-\u23FF][\uFE00-\uFEFF]?|[\u2460-\u24FF][\uFE00-\uFEFF]?|[\u25A0-\u25FF][\uFE00-\uFEFF]?|[\u2600-\u27BF][\uFE00-\uFEFF]?|[\u2900-\u297F][\uFE00-\uFEFF]?|[\u2B00-\u2BF0][\uFE00-\uFEFF]?|(?:\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDEFF])[\uFE00-\uFEFF]?/g,""):""}onSelectChange(e){e.preventDefault(),this.elements.$targetLoader.hide(),this.elements.$target.attr("aria-busy","false"),this.elements.$targetButton.attr("aria-expanded","false"),this.elements.$target.empty(),this.elements.$targetHeader.html("")}onTriggerButton(e){e.preventDefault(),this.elements.$targetButton.attr("aria-expanded","true"),this.elements.$target.empty(),this.elements.$targetHeader.html(""),this.elements.instanceAjax=new EacReadTheFeed(jQuery(".select__options-items option:selected",this.elements.$targetInstance).val().replace(/\s+/g,""),this.elements.targetNonce,this.elements.settings.data_id),this.elements.$targetLoader.show(),this.elements.$target.attr("aria-busy","true")}onTriggerKeyboard(e){const t=e.code||e.key||0;if(!this.elements.$target.is(":empty"))if("Escape"===t)e.preventDefault(),this.elements.$targetButton.attr("aria-expanded","false"),this.elements.$target.empty(),this.elements.$targetHeader.html(""),this.elements.$targetSelect.trigger("focus");else if("End"===t){e.preventDefault();this.elements.$target.find("article").find("a").last().trigger("focus")}else if("Home"===t){e.preventDefault();this.elements.$target.find("article").find("a").first().trigger("focus")}}ajaxQueryComplete(e,t,s){if(null!==this.elements.instanceAjax&&s.ajaxOptions&&s.ajaxOptions===this.elements.instanceAjax.getOptions()){e.stopImmediatePropagation(),this.elements.$targetLoader.hide(),this.elements.$target.attr("aria-busy","false");const t=this.elements.instanceAjax.getItems();if(t.headError)return this.elements.$targetHeader.html('<span style="text-align:center; word-break:break-word;"><p>'+t.headError+"</p></span>"),!1;if(!t.rss)return this.elements.$targetHeader.html('<span style="text-align: center">Nothing to display</span>'),!1;const s=t.rss,a=t.profile,i=jQuery("<div/>",{class:"rss-item__header-content"});a.headLogo&&this.elements.$targetHeader.append('<div class="rss-item__header-img"><a href="'+a.headLink+'" aria-label="View RSS feed provider '+a.headTitle+'"><img src="'+a.headLogo+'" alt="'+a.headTitle+'"></a></div>'),i.append('<span><a href="'+a.headLink+'" aria-label="View RSS feed provider '+a.headTitle+'"><h2><span dir="ltr">'+a.headTitle.substring(0,27)+"...</span></h2></a></span>"),i.append("<span>"+a.headDescription+"</span>"),this.elements.$targetHeader.append(i);const n=this.getElementSettings("button_more_picto");let r="";if(n)if(elementorFrontend.config.experimentalFeatures.e_font_icon_svg&&!elementorFrontend.isEditMode()){const e=void 0!==n.rendered_tag?n.rendered_tag:"";e&&(r=e.replace("<svg",'<svg aria-hidden="true"'))}else r=n.value?`<i class="${n.value}" aria-hidden='true'></i>`:"";if(jQuery.each(s,((e,t)=>{if(e>=this.elements.settings.data_nombre)return!1;const s=jQuery("<article/>",{class:"rss-galerie__item"});let a=jQuery("<div/>",{class:"rss-galerie__content"});const i=jQuery("<div/>",{class:"rss-galerie__content-inner"});if(t.img&&this.elements.settings.data_img){let e="",s="",i="";i=this.elements.settings.data_global_link?"eac-accessible-link card-link":"eac-accessible-link";const n=jQuery.trim(t.title.replace(/"/g,""));t.img.match(/\.mp3|\.m4a/)?e='<div class="rss-galerie__item-image"><audio aria-label="Listen feed '+n+'" controls preload="none" src="'+t.img+'" type="audio/mp3"></audio></div>':t.img.match(/\.mp4|\.m4v/)?(s=this.is_ios?'<video aria-label="View feed video '+n+'" controls preload="metadata" type="video/mp4">':'<video controls preload="none" type="video/mp4">',e='<div class="rss-galerie__item-image">'+s+'<source src="'+t.img+"\">Your browser doesn't support embedded videos</video></div>"):e=t.img.match(/\.pdf/)?'<div class="rss-galerie__item-image" aria-label="View PDF file '+n+'"><a href="'+t.imgLink+'" data-elementor-open-lightbox="no" data-fancybox="rss-gallery" data-caption="'+n+'"><i class="far fa-file-pdf" aria-hidden="true"></i></a></div>':this.elements.settings.data_lightbox?'<div class="rss-galerie__item-image"><a href="'+t.imgLink+'" class="eac-accessible-link" aria-label="View feed image '+n+'" data-elementor-open-lightbox="no" data-fancybox="rss-gallery" data-caption="'+n+'"><img class="img-focusable" src="'+t.img+'"></a></div>':this.elements.settings.data_image_link?'<div class="rss-galerie__item-image"><a href="'+t.lien+'" class="'+i+'" aria-label="View feed '+n+'"><img class="img-focusable" src="'+t.img+'"></a></div>':'<div class="rss-galerie__item-image"><img src="'+t.img+'"></div>',a.append(e)}if(this.elements.settings.data_title){t.title=this.removeEmojis(t.title),t.title=t.title.split(" ",12).join().replace(/,/g," ").replace(/["”“]+/g,"")+"...";let e="";if(this.elements.settings.data_title_link){let s="";s=this.elements.settings.data_global_link?"eac-accessible-link card-link":"eac-accessible-link",e='<div class="rss-galerie__item-link-post"><a href="'+t.lien+'" class="'+s+'" aria-label="View feed '+t.title+'"><h2 class="rss-galerie__item-titre"><span dir="ltr">'+t.title+"</span></h2></a></div>"}else e='<div class="rss-galerie__item-link-post"><h2 class="rss-galerie__item-titre"><span dir="ltr">'+t.title+"</span></h2></div>";i.append(e)}if(this.elements.settings.data_excerpt){t.description=this.removeEmojis(t.description),t.description=t.description.split(" ",this.elements.settings.data_excerpt_lenght).join().replace(/,/g," ").replace(/["”“]+/g,"")+"...";const e='<div class="rss-galerie__item-description"><p><span dir="ltr">'+t.description+"</span></p></div>";i.append(e)}if(this.elements.settings.data_readmore){let e='<span class="label-icon">'+this.elements.settings.data_readmore_label+"</span>";if(r.length>0){const t='<span class="button-icon eac-icon-svg">'+r+"</span>";"before"===this.elements.settings.data_icon_pos?e=t+e:e+=t}let s="";s=this.elements.settings.data_global_link?"button-readmore card-link":"button-readmore";const a='<div class="buttons-wrapper"><a href="'+t.lien+'" class="'+s+'" aria-label="View feed '+t.title+'"><span class="button__readmore-wrapper">'+e+"</span></a></div>";i.append(a)}if(this.elements.settings.data_date){const e='<svg aria-hidden="true" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M313.6 304c-28.7 0-42.5 16-89.6 16-47.1 0-60.8-16-89.6-16C60.2 304 0 364.2 0 438.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-25.6c0-74.2-60.2-134.4-134.4-134.4zM400 464H48v-25.6c0-47.6 38.8-86.4 86.4-86.4 14.6 0 38.3 16 89.6 16 51.7 0 74.9-16 89.6-16 47.6 0 86.4 38.8 86.4 86.4V464zM224 288c79.5 0 144-64.5 144-144S303.5 0 224 0 80 64.5 80 144s64.5 144 144 144zm0-240c52.9 0 96 43.1 96 96s-43.1 96-96 96-96-43.1-96-96 43.1-96 96-96z"></path></svg>',s='<svg aria-hidden="true" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M400 64h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zm-6 400H54c-3.3 0-6-2.7-6-6V160h352v298c0 3.3-2.7 6-6 6z"></path></svg>',a=jQuery("<div/>",{class:"rss-galerie__item-metas"}),n='<span class="rss-galerie__item-date eac-icon-svg">'+s+new Date(t.update).toLocaleDateString(this.elements.settings.data_locale,{year:"numeric",month:"2-digit",day:"2-digit"})+"</span>",r='<span class="rss-galerie__item-auteur eac-icon-svg">'+e+t.author+"</span>";a.append(n),t.author&&a.append(r),i.append(a)}a.append(i),s.append(a),this.elements.$target.append(s)})),setTimeout((()=>{jQuery(".rss-galerie__item",this.elements.$target).css({transition:"all 500ms linear",transform:"scale(1)"})}),200),this.elements.settings.data_global_link){const e=this.elements.$target.find(".rss-galerie__content");setGridItemsGlobalLink(e)}}}}jQuery(window).on("elementor/frontend/init",(()=>{elementorFrontend.elementsHandler.attachHandler("eac-addon-lecteur-rss",widgetRssReader)}));